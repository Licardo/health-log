<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health Log V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f3f4f6; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }
        /* è¾“å…¥æ¡†èšç„¦ç¯ */
        .input-focus:focus { ring: 2px; ring-color: #10b981; outline: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-700">

<div id="app" class="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl relative">

    <!-- é¡¶éƒ¨ Header -->
    <header class="bg-emerald-600 text-white p-5 pt-8 pb-10 rounded-b-3xl shadow-lg shrink-0 z-10 relative">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold"><i class="fas fa-heartbeat mr-2"></i>Health Log</h1>
            <!-- ä»…åœ¨è¡¥å‰‚é¡µé¢æ˜¾ç¤ºè®¾ç½®æŒ‰é’® -->
            <button v-if="currentTab === 'daily'" @click="showSuppManage = true" class="bg-emerald-700 p-2 rounded-lg hover:bg-emerald-800 transition">
                <i class="fas fa-cog"></i>
            </button>
        </div>
        <div class="flex justify-between items-end">
            <div>
                <p class="text-emerald-100 text-xs mb-1">{{ currentDate }}</p>
                <div class="flex items-baseline">
                    <span class="text-3xl font-bold">{{ completionRate }}%</span>
                    <span class="ml-2 text-sm opacity-80">ä»Šæ—¥å®Œæˆåº¦</span>
                </div>
            </div>
            <!-- å¤´åƒ/ç”¨æˆ· -->
            <div class="bg-white/20 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm">
                <i class="fas fa-user text-lg"></i>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-1 overflow-y-auto no-scrollbar -mt-6 px-4 pb-24 z-0 pt-2">

        <!-- ==================== Tab 1: ä»Šæ—¥è¡¥å‰‚ ==================== -->
        <div v-if="currentTab === 'daily'" class="space-y-4">
            <!-- åˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 border-b border-gray-50 flex justify-between items-center">
                    <h2 class="font-bold text-gray-800">ä»Šæ—¥æ‰“å¡</h2>
                    <button @click="resetDaily" class="text-xs text-gray-400 hover:text-emerald-600"><i class="fas fa-redo mr-1"></i>é‡ç½®</button>
                </div>
                
                <div v-if="activeSupplements.length === 0" class="p-8 text-center text-gray-400 text-sm">
                    æš‚æ— é…ç½®è¡¥å‰‚ï¼Œç‚¹å‡»å³ä¸Šè§’ âš™ï¸ æ·»åŠ 
                </div>

                <div v-for="(item, index) in activeSupplements" :key="item.id" 
                     @click="toggleSupplement(item.id)"
                     class="flex items-center justify-between p-4 border-b last:border-0 cursor-pointer transition-colors hover:bg-gray-50"
                     :class="item.done ? 'bg-emerald-50/50' : ''">
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-full border-2 mr-3 flex items-center justify-center transition-all"
                             :class="item.done ? 'bg-emerald-500 border-emerald-500' : 'border-gray-300'">
                            <i v-if="item.done" class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div>
                            <p class="font-medium text-sm" :class="item.done ? 'text-gray-400 line-through' : 'text-gray-800'">{{ item.name }}</p>
                            <p class="text-xs text-gray-400">{{ item.dosage }} Â· {{ item.time }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å†å²å…¥å£ -->
            <button @click="showSuppHistory = true" class="w-full bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between group">
                <span class="text-sm font-medium text-gray-600"><i class="fas fa-calendar-alt text-emerald-500 mr-2"></i>æŸ¥çœ‹æ‰“å¡å†å² (Calendar)</span>
                <i class="fas fa-chevron-right text-gray-300 group-hover:text-emerald-500"></i>
            </button>
        </div>

        <!-- ==================== Tab 2: ç”¨è¯è®°å½• ==================== -->
        <div v-if="currentTab === 'meds'" class="space-y-4">
            <!-- å¿«é€Ÿè®°å½•å¡ç‰‡ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h2 class="font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-plus-circle text-orange-500 mr-2"></i> å¿«é€Ÿè®°å½•</h2>
                <div class="space-y-3">
                    <input v-model="newMed.name" type="text" placeholder="è¯å“åç§° (å¦‚: å¸ƒæ´›èŠ¬)" class="w-full bg-gray-50 p-3 rounded-lg text-sm border-none focus:ring-2 focus:ring-orange-200 outline-none">
                    <input v-model="newMed.reason" type="text" placeholder="ç—‡çŠ¶ (å¦‚: å¤´ç—›)" class="w-full bg-gray-50 p-3 rounded-lg text-sm border-none focus:ring-2 focus:ring-orange-200 outline-none">
                    <button @click="addMedRecord" :disabled="!newMed.name" class="w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white py-2.5 rounded-lg font-medium shadow-md shadow-orange-200 active:scale-95 transition disabled:opacity-50">
                        æäº¤è®°å½•
                    </button>
                </div>
            </div>

            <!-- æœ€è¿‘è®°å½• (Top 3) -->
            <div class="space-y-2">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-xs font-bold text-gray-400 uppercase">æœ€è¿‘è®°å½•</h3>
                    <button @click="showMedHistory = true" class="text-xs text-orange-500 font-medium">æŸ¥çœ‹å…¨éƒ¨æ¡£æ¡ˆ</button>
                </div>
                <div v-for="(log, index) in medHistory.slice(0,3)" :key="log.id" class="bg-white p-3 rounded-xl shadow-sm border-l-4 border-orange-400 flex justify-between">
                    <div>
                        <p class="font-bold text-sm text-gray-800">{{ log.name }}</p>
                        <span class="text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded mt-1 inline-block">{{ log.reason }}</span>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">{{ formatDate(log.timestamp) }}</p>
                        <p class="text-xs text-gray-300">{{ formatTime(log.timestamp) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== Tab 3: å®šæœŸæ£€æŸ¥ ==================== -->
        <div v-if="currentTab === 'plans'" class="space-y-4">
            <!-- å¾…åŠåˆ—è¡¨ -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-4 bg-blue-50/50 border-b border-blue-100 flex justify-between items-center">
                    <h2 class="font-bold text-blue-800 text-sm">ğŸ“… å¾…åŠæ£€æŸ¥</h2>
                    <button @click="openPlanEdit(null)" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 transition"><i class="fas fa-plus"></i> æ–°å¢</button>
                </div>
                <div v-if="pendingPlans.length === 0" class="p-6 text-center text-gray-400 text-xs">æš‚æ— å¾…åŠè®¡åˆ’</div>
                
                <div v-for="plan in pendingPlans" :key="plan.id" @click="openPlanEdit(plan)" class="p-4 border-b last:border-0 hover:bg-gray-50 transition cursor-pointer flex justify-between items-center group">
                    <div>
                        <div class="flex items-center mb-1">
                            <span class="w-2 h-2 rounded-full mr-2" :class="getPlanColor(plan.type)"></span>
                            <span class="font-medium text-gray-800 text-sm">{{ plan.name }}</span>
                        </div>
                        <p class="text-xs text-gray-500 ml-4">è®¡åˆ’: {{ plan.dueDate }}</p>
                    </div>
                    <i class="fas fa-chevron-right text-gray-300 text-xs group-hover:text-blue-500"></i>
                </div>
            </div>

            <!-- å·²å®Œæˆ/å†å² -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden opacity-90">
                <div class="p-3 bg-gray-50 border-b border-gray-100">
                    <h2 class="font-bold text-gray-500 text-sm">ğŸ“‚ å†å²æ¡£æ¡ˆ</h2>
                </div>
                <div v-for="plan in donePlans" :key="plan.id" @click="openPlanEdit(plan)" class="p-4 border-b last:border-0 hover:bg-gray-50 transition cursor-pointer">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-medium text-gray-800 text-sm line-through decoration-gray-400">{{ plan.name }}</p>
                            <p class="text-xs text-green-600 mt-1"><i class="fas fa-check-circle"></i> å®Œæˆäº {{ plan.doneDate || plan.dueDate }}</p>
                        </div>
                        <div v-if="plan.resultSummary" class="bg-gray-100 p-2 rounded max-w-[120px]">
                            <p class="text-xs text-gray-500 truncate">{{ plan.resultSummary }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-t border-gray-100 shrink-0 pb-safe z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.02)]">
        <div class="flex justify-around items-center h-16">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                class="flex flex-col items-center w-1/3 py-2 transition duration-200" 
                :class="currentTab === tab.id ? tab.color : 'text-gray-300'">
                <i :class="[tab.icon, 'text-xl mb-1']"></i>
                <span class="text-[10px] font-medium">{{ tab.label }}</span>
            </button>
        </div>
    </nav>

    <!-- ========================================================================= -->
    <!--                                MODALS (å¼¹çª—å±‚)                             -->
    <!-- ========================================================================= -->

    <!-- 1. è¡¥å‰‚ç®¡ç† Modal -->
    <transition name="modal">
        <div v-if="showSuppManage" class="absolute inset-0 z-50 bg-gray-900/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-white w-full h-[85%] sm:h-auto sm:max-w-md sm:rounded-2xl rounded-t-2xl flex flex-col shadow-2xl">
                <div class="p-4 border-b flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-gray-800">è¡¥å‰‚æ¸…å•é…ç½®</h3>
                    <button @click="showSuppManage = false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                    <div v-for="(item, idx) in supplementsConfig" :key="item.id" class="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                        <div class="flex-1">
                            <input v-model="item.name" class="font-bold text-gray-800 w-full mb-1 outline-none border-b border-transparent focus:border-emerald-300 placeholder-gray-300" placeholder="è¡¥å‰‚åç§°">
                            <div class="flex space-x-2">
                                <input v-model="item.dosage" class="text-xs text-gray-500 bg-gray-100 rounded px-1 w-20 outline-none" placeholder="å‰‚é‡">
                                <select v-model="item.time" class="text-xs text-gray-500 bg-gray-100 rounded outline-none">
                                    <option>æ—©æ™¨</option><option>åˆé¤</option><option>ç¡å‰</option>
                                </select>
                            </div>
                        </div>
                        <button @click="deleteSupplement(idx)" class="ml-3 w-8 h-8 rounded-full bg-red-50 text-red-400 hover:bg-red-100 flex items-center justify-center"><i class="fas fa-trash-alt text-xs"></i></button>
                    </div>
                    <button @click="addSupplementConfig" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:border-emerald-400 hover:text-emerald-500 transition">
                        <i class="fas fa-plus mr-2"></i> æ·»åŠ æ–°è¡¥å‰‚
                    </button>
                </div>
                <div class="p-4 border-t bg-white pb-safe rounded-b-2xl">
                    <button @click="saveSuppConfig" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-emerald-200">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 2. è¡¥å‰‚å†å² Modal (ç®€å•æ—¥å†æ¨¡æ‹Ÿ) -->
    <transition name="modal">
        <div v-if="showSuppHistory" class="absolute inset-0 z-50 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center px-4">
            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800">æ‰“å¡çƒ­åŠ›å›¾ (æ¨¡æ‹Ÿ)</h3>
                    <button @click="showSuppHistory = false" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center mb-2">
                    <span v-for="d in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" :key="d" class="text-xs text-gray-400">{{d}}</span>
                </div>
                <div class="grid grid-cols-7 gap-2">
                    <!-- æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ -->
                    <div v-for="n in 30" :key="n" class="aspect-square rounded flex items-center justify-center text-xs relative"
                         :class="n > 25 ? 'bg-gray-100 text-gray-300' : (Math.random()>0.3 ? 'bg-emerald-500 text-white' : 'bg-emerald-100 text-emerald-600')">
                        {{ n }}
                    </div>
                </div>
                <p class="text-xs text-center text-gray-400 mt-4">æ·±è‰²=å…¨å‹¤ï¼Œæµ…è‰²=ç¼ºå‹¤ï¼Œç°è‰²=æœªæ¥</p>
            </div>
        </div>
    </transition>

    <!-- 3. ç”¨è¯æ¡£æ¡ˆæœç´¢ Modal -->
    <transition name="modal">
        <div v-if="showMedHistory" class="absolute inset-0 z-50 bg-white flex flex-col">
            <div class="p-4 border-b flex items-center space-x-3 pt-safe">
                <button @click="showMedHistory = false" class="text-gray-500"><i class="fas fa-arrow-left"></i></button>
                <div class="flex-1 bg-gray-100 rounded-lg flex items-center px-3 py-2">
                    <i class="fas fa-search text-gray-400 mr-2"></i>
                    <input v-model="medSearch" type="text" placeholder="æœç´¢è¯å“æˆ–ç—‡çŠ¶..." class="bg-transparent w-full text-sm outline-none">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <div v-for="log in filteredMedHistory" :key="log.id" class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-gray-800">{{ log.name }}</h4>
                        <span class="text-xs text-gray-400">{{ formatDate(log.timestamp) }}</span>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">ç—‡çŠ¶: {{ log.reason }}</p>
                </div>
                <div v-if="filteredMedHistory.length === 0" class="text-center text-gray-400 mt-10">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</div>
            </div>
        </div>
    </transition>

    <!-- 4. æ£€æŸ¥è¯¦æƒ…ä¸ç»“æœå½•å…¥ Modal -->
    <transition name="modal">
        <div v-if="editingPlan" class="absolute inset-0 z-50 bg-gray-900/50 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl p-5 shadow-2xl max-h-[90%] overflow-y-auto">
                
                <!-- å¤´éƒ¨ -->
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-gray-800">{{ editingPlan.id ? 'ç¼–è¾‘æ£€æŸ¥è®¡åˆ’' : 'æ–°å¢è®¡åˆ’' }}</h3>
                    <button @click="closePlanEdit" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                </div>

                <!-- åŸºç¡€ä¿¡æ¯è¡¨å• -->
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">æ£€æŸ¥åç§°</label>
                        <input v-model="editingPlanTemp.name" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm focus:border-blue-400 outline-none" placeholder="ä¾‹å¦‚ï¼šè¡€å¸¸è§„">
                    </div>
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ç±»å‹</label>
                            <select v-model="editingPlanTemp.type" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                                <option value="annual">å¹´åº¦å¤§æ£€</option>
                                <option value="quarterly">å­£åº¦æ£€æŸ¥</option>
                                <option value="dental">ç‰™ç§‘/ä¸“é¡¹</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-gray-500 mb-1">è®¡åˆ’æ—¥æœŸ</label>
                            <input v-model="editingPlanTemp.dueDate" type="date" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2.5 text-sm outline-none">
                        </div>
                    </div>
                </div>

                <!-- ç»“æœå½•å…¥åŒºåŸŸ (ä»…åœ¨ç¼–è¾‘ç°æœ‰ä¸”æœªå®Œæˆçš„ä»»åŠ¡æ—¶æ˜¾ç¤ºï¼Œæˆ–è€…æŸ¥çœ‹å·²å®Œæˆè¯¦æƒ…æ—¶) -->
                <div v-if="editingPlan.id" class="border-t pt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-xs font-bold text-blue-600 uppercase">æ£€æŸ¥ç»“æœå½’æ¡£</label>
                        <span v-if="editingPlanTemp.status === 'done'" class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">å·²å½’æ¡£</span>
                    </div>
                    
                    <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100 space-y-3">
                        <textarea v-model="editingPlanTemp.resultSummary" rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-3 text-sm placeholder-blue-300 focus:ring-1 focus:ring-blue-400 outline-none" placeholder="åœ¨æ­¤è¾“å…¥åŒ»ç”Ÿå»ºè®®æˆ–æ£€æŸ¥ç»“è®ºæ‘˜è¦..."></textarea>
                        
                        <!-- æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼  -->
                        <div class="relative border-2 border-dashed border-blue-200 rounded-lg p-4 text-center bg-white hover:bg-blue-50 transition cursor-pointer">
                            <input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" @change="handleFileUpload">
                            <div v-if="!editingPlanTemp.fileName">
                                <i class="fas fa-cloud-upload-alt text-blue-300 text-2xl mb-1"></i>
                                <p class="text-xs text-blue-400">ç‚¹å‡»ä¸Šä¼ ä½“æ£€æŠ¥å‘Š (å›¾ç‰‡/PDF)</p>
                            </div>
                            <div v-else class="flex items-center justify-center text-blue-600">
                                <i class="fas fa-file-alt mr-2"></i>
                                <span class="text-xs truncate max-w-[150px]">{{ editingPlanTemp.fileName }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- åº•éƒ¨æŒ‰é’®ç»„ -->
                <div class="mt-6 flex space-x-3">
                    <button v-if="editingPlan.id" @click="deletePlan" class="px-4 py-3 rounded-xl text-red-500 bg-red-50 font-bold text-sm hover:bg-red-100">åˆ é™¤</button>
                    
                    <div class="flex-1 flex space-x-2">
                        <!-- å¦‚æœæ˜¯å·²å®Œæˆï¼Œåªæ˜¾ç¤ºä¿å­˜ä¿®æ”¹ -->
                        <button v-if="editingPlanTemp.status === 'done'" @click="savePlan(false)" class="flex-1 bg-gray-800 text-white py-3 rounded-xl font-bold shadow-lg">æ›´æ–°è®°å½•</button>
                        
                        <!-- å¦‚æœæ˜¯æœªå®Œæˆï¼Œæ˜¾ç¤ºä¿å­˜å’Œå®Œæˆå¹¶å½’æ¡£ -->
                        <template v-else>
                            <button @click="savePlan(false)" class="flex-1 bg-white border border-gray-200 text-gray-700 py-3 rounded-xl font-bold">ä»…ä¿å­˜</button>
                            <button @click="savePlan(true)" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200">
                                <i class="fas fa-check-double mr-1"></i> å®Œæˆå¹¶å½’æ¡£
                            </button>
                        </template>
                    </div>
                </div>

            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'daily',
                currentDate: new Date().toLocaleDateString('zh-CN', {month:'long', day:'numeric', weekday:'short'}),
                tabs: [
                    { id: 'daily', label: 'ä»Šæ—¥è¡¥å‰‚', icon: 'fas fa-sun', color: 'text-emerald-600' },
                    { id: 'meds', label: 'ç”¨è¯è®°å½•', icon: 'fas fa-capsules', color: 'text-orange-500' },
                    { id: 'plans', label: 'å®šæœŸæ£€æŸ¥', icon: 'fas fa-clipboard-list', color: 'text-blue-600' }
                ],
                
                // --- 1. è¡¥å‰‚æ•°æ® ---
                showSuppManage: false,
                showSuppHistory: false,
                // é…ç½®åˆ—è¡¨ (æ¨¡æ¿)
                supplementsConfig: [], 
                // ä»Šæ—¥æ‰“å¡çŠ¶æ€ (Record: {id: 1, done: true})
                dailyRecords: {}, 

                // --- 2. ç”¨è¯æ•°æ® ---
                newMed: { name: '', reason: '' },
                medHistory: [],
                showMedHistory: false,
                medSearch: '',

                // --- 3. æ£€æŸ¥è®¡åˆ’æ•°æ® ---
                healthPlans: [],
                editingPlan: null, // å½“å‰æ­£åœ¨ç¼–è¾‘çš„åŸå§‹å¯¹è±¡
                editingPlanTemp: {}, // ç¼–è¾‘ä¸­çš„ä¸´æ—¶å‰¯æœ¬
            }
        },
        computed: {
            // å°†é…ç½®å’Œä»Šæ—¥æ‰“å¡çŠ¶æ€åˆå¹¶ï¼Œç”Ÿæˆæ¸²æŸ“åˆ—è¡¨
            activeSupplements() {
                return this.supplementsConfig.map(item => ({
                    ...item,
                    done: !!this.dailyRecords[item.id]
                }));
            },
            completionRate() {
                if (this.supplementsConfig.length === 0) return 0;
                const doneCount = Object.values(this.dailyRecords).filter(Boolean).length;
                return Math.round((doneCount / this.supplementsConfig.length) * 100);
            },
            filteredMedHistory() {
                if (!this.medSearch) return this.medHistory;
                const q = this.medSearch.toLowerCase();
                return this.medHistory.filter(l => l.name.toLowerCase().includes(q) || l.reason.toLowerCase().includes(q));
            },
            pendingPlans() { return this.healthPlans.filter(p => p.status !== 'done'); },
            donePlans() { return this.healthPlans.filter(p => p.status === 'done').sort((a,b) => b.doneDate?.localeCompare(a.doneDate)); }
        },
        mounted() {
            this.initData();
        },
        methods: {
            // --- åˆå§‹åŒ–/æ•°æ®åŠ è½½ ---
            initData() {
                // è¯»å–æˆ–è®¾ç½®é»˜è®¤å€¼
                const defaultConfig = [
                    { id: 1, name: 'ç»¼åˆç»´ç”Ÿç´ ', dosage: '1ç²’', time: 'æ—©é¤' },
                    { id: 2, name: 'é±¼æ²¹ Omega-3', dosage: '2ç²’', time: 'åˆé¤' }
                ];
                
                this.supplementsConfig = JSON.parse(localStorage.getItem('v2_suppConfig')) || defaultConfig;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„ä¸€å¤©ï¼Œé‡ç½®æ‰“å¡
                const lastDate = localStorage.getItem('v2_lastDate');
                const todayStr = new Date().toDateString();
                if (lastDate !== todayStr) {
                    this.dailyRecords = {};
                    localStorage.setItem('v2_lastDate', todayStr);
                } else {
                    this.dailyRecords = JSON.parse(localStorage.getItem('v2_dailyRecords')) || {};
                }

                this.medHistory = JSON.parse(localStorage.getItem('v2_meds')) || [];
                this.healthPlans = JSON.parse(localStorage.getItem('v2_plans')) || [
                    { id: 101, name: 'å¹´åº¦ä½“æ£€', type: 'annual', dueDate: '2025-10-01', status: 'pending' }
                ];
            },
            saveAll() {
                localStorage.setItem('v2_suppConfig', JSON.stringify(this.supplementsConfig));
                localStorage.setItem('v2_dailyRecords', JSON.stringify(this.dailyRecords));
                localStorage.setItem('v2_meds', JSON.stringify(this.medHistory));
                localStorage.setItem('v2_plans', JSON.stringify(this.healthPlans));
            },

            // --- è¡¥å‰‚é€»è¾‘ ---
            toggleSupplement(id) {
                this.dailyRecords[id] = !this.dailyRecords[id];
                this.saveAll();
            },
            resetDaily() {
                this.dailyRecords = {};
                this.saveAll();
            },
            // ç®¡ç†é…ç½®
            addSupplementConfig() {
                this.supplementsConfig.push({ id: Date.now(), name: '', dosage: '', time: 'æ—©æ™¨' });
            },
            deleteSupplement(idx) {
                this.supplementsConfig.splice(idx, 1);
            },
            saveSuppConfig() {
                // è¿‡æ»¤æ‰ç©ºåå­—çš„
                this.supplementsConfig = this.supplementsConfig.filter(s => s.name.trim());
                this.showSuppManage = false;
                this.saveAll();
            },

            // --- ç”¨è¯é€»è¾‘ ---
            addMedRecord() {
                this.medHistory.unshift({
                    id: Date.now(),
                    name: this.newMed.name,
                    reason: this.newMed.reason || 'å¸¸è§„',
                    timestamp: Date.now()
                });
                this.newMed.name = ''; this.newMed.reason = '';
                this.saveAll();
                alert('å·²è®°å½•å¹¶åŒæ­¥ (æ¨¡æ‹Ÿ)'); // è¿™é‡Œåç»­æ¥ API
            },

            // --- è®¡åˆ’/æ£€æŸ¥é€»è¾‘ ---
            getPlanColor(type) {
                return { 'annual': 'bg-blue-500', 'quarterly': 'bg-indigo-400', 'dental': 'bg-teal-400' }[type] || 'bg-gray-400';
            },
            openPlanEdit(plan) {
                if (plan) {
                    this.editingPlan = plan;
                    this.editingPlanTemp = JSON.parse(JSON.stringify(plan)); // æ·±æ‹·è´
                } else {
                    this.editingPlan = {}; // æ ‡è®°ä¸ºæ–°å¢
                    this.editingPlanTemp = { id: null, name: '', type: 'quarterly', dueDate: '', status: 'pending', resultSummary: '' };
                }
            },
            closePlanEdit() { this.editingPlan = null; },
            handleFileUpload(e) {
                const file = e.target.files[0];
                if (file) this.editingPlanTemp.fileName = file.name;
            },
            savePlan(markAsDone) {
                if (!this.editingPlanTemp.name) return alert('è¯·è¾“å…¥æ£€æŸ¥åç§°');

                // å¦‚æœæ˜¯æ ‡è®°å®Œæˆ
                if (markAsDone) {
                    this.editingPlanTemp.status = 'done';
                    this.editingPlanTemp.doneDate = new Date().toISOString().split('T')[0];
                }

                if (this.editingPlanTemp.id) {
                    // æ›´æ–°ç°æœ‰
                    const idx = this.healthPlans.findIndex(p => p.id === this.editingPlanTemp.id);
                    if (idx !== -1) this.healthPlans[idx] = this.editingPlanTemp;
                } else {
                    // æ–°å¢
                    this.editingPlanTemp.id = Date.now();
                    this.healthPlans.push(this.editingPlanTemp);
                }
                
                this.saveAll();
                this.closePlanEdit();
            },
            deletePlan() {
                if(!confirm('ç¡®å®šåˆ é™¤æ­¤è®¡åˆ’å—ï¼Ÿ')) return;
                const idx = this.healthPlans.findIndex(p => p.id === this.editingPlanTemp.id);
                this.healthPlans.splice(idx, 1);
                this.saveAll();
                this.closePlanEdit();
            },

            // --- å·¥å…· ---
            formatDate(ts) { return new Date(ts).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}); },
            formatTime(ts) { return new Date(ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}); }
        }
    }).mount('#app');
</script>
</body>
</html>