<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Health Log V2.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal-enter-active, .modal-leave-active { transition: all 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; transform: translateY(20px); }
        /* æ—¶é—´è½´è¿æ¥çº¿æ•ˆæœ */
        .timeline-line::before {
            content: ''; position: absolute; top: 20px; bottom: -20px; left: 15px; width: 2px; background: #e2e8f0; z-index: 0;
        }
        .timeline-item:last-child .timeline-line::before { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-700 bg-gray-50">

<div id="app" class="flex flex-col h-full max-w-md mx-auto bg-white shadow-2xl relative">

    <!-- Header -->
    <header class="bg-slate-800 text-white p-5 pt-10 pb-12 rounded-b-[2.5rem] shadow-xl shrink-0 z-10 relative overflow-hidden">
        <!-- è£…é¥°èƒŒæ™¯åœ† -->
        <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/5 rounded-full blur-2xl"></div>
        
        <div class="flex justify-between items-center mb-6 relative z-10">
            <h1 class="text-xl font-bold tracking-wide"><i class="fas fa-heartbeat text-emerald-400 mr-2"></i>Health Log</h1>
            <button v-if="currentTab === 'daily'" @click="showSuppManage = true" class="bg-slate-700/50 p-2 rounded-full hover:bg-slate-700 transition backdrop-blur-md border border-white/10">
                <i class="fas fa-cog text-sm"></i>
            </button>
        </div>
        <div class="flex justify-between items-end relative z-10">
            <div>
                <p class="text-slate-400 text-xs mb-1 font-medium tracking-wider uppercase">{{ currentDate }}</p>
                <div class="flex items-baseline">
                    <span class="text-4xl font-bold text-white">{{ completionRate }}<span class="text-xl">%</span></span>
                    <span class="ml-2 text-xs text-emerald-400 font-medium bg-emerald-400/10 px-2 py-0.5 rounded-full">ä»Šæ—¥å®Œæˆ</span>
                </div>
            </div>
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-emerald-400 to-cyan-500 flex items-center justify-center shadow-lg shadow-emerald-500/20">
                <i class="fas fa-user text-white text-sm"></i>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto no-scrollbar -mt-8 px-4 pb-24 z-0 pt-2">

        <!-- Tab 1: Daily Supplements -->
        <div v-if="currentTab === 'daily'" class="space-y-5">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-white">
                    <h2 class="font-bold text-slate-700 text-sm">ä»Šæ—¥æ‰“å¡</h2>
                    <button @click="resetDaily" class="text-xs text-slate-400 hover:text-emerald-500 flex items-center"><i class="fas fa-redo-alt mr-1"></i>é‡ç½®</button>
                </div>
                
                <div v-if="activeSupplements.length === 0" class="p-10 text-center">
                    <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><i class="fas fa-pills"></i></div>
                    <p class="text-slate-400 text-xs">æš‚æ— è¡¥å‰‚ï¼Œç‚¹å‡»å³ä¸Šè§’è®¾ç½®æ·»åŠ </p>
                </div>

                <div v-for="(item, index) in activeSupplements" :key="item.id" 
                     @click="toggleSupplement(item.id)"
                     class="flex items-center justify-between p-4 border-b border-slate-50 last:border-0 cursor-pointer group hover:bg-slate-50 transition-all"
                     :class="item.done ? 'bg-emerald-50/30' : ''">
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded-lg border-2 mr-4 flex items-center justify-center transition-all duration-300"
                             :class="item.done ? 'bg-emerald-500 border-emerald-500 scale-110 shadow-lg shadow-emerald-200' : 'border-slate-200 group-hover:border-emerald-300'">
                            <i v-if="item.done" class="fas fa-check text-white text-[10px]"></i>
                        </div>
                        <div>
                            <p class="font-bold text-sm transition-colors" :class="item.done ? 'text-slate-400 line-through decoration-slate-300' : 'text-slate-700'">{{ item.name }}</p>
                            <p class="text-[10px] font-medium uppercase tracking-wide mt-0.5" :class="item.done ? 'text-slate-300' : 'text-slate-400'">{{ item.dosage }} Â· {{ item.time }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Entry -->
            <button @click="showSuppHistory = true" class="w-full bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between group hover:shadow-md transition-all">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center mr-3"><i class="fas fa-calendar-day text-xs"></i></div>
                    <span class="text-sm font-bold text-slate-600">æ‰“å¡çƒ­åŠ›å›¾</span>
                </div>
                <i class="fas fa-chevron-right text-xs text-slate-300 group-hover:text-indigo-500 transition-colors"></i>
            </button>
        </div>

        <!-- Tab 2: Meds -->
        <div v-if="currentTab === 'meds'" class="space-y-5">
            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                <h2 class="font-bold text-slate-700 mb-4 text-sm flex items-center"><i class="fas fa-edit text-orange-400 mr-2"></i>å¿«é€Ÿè®°å½•</h2>
                <div class="space-y-3">
                    <div class="relative">
                        <i class="fas fa-capsules absolute left-3 top-3.5 text-slate-300 text-xs"></i>
                        <input v-model="newMed.name" type="text" placeholder="è¯å“åç§°" class="w-full bg-slate-50 pl-9 p-3 rounded-xl text-sm border border-transparent focus:bg-white focus:border-orange-200 outline-none transition-all">
                    </div>
                    <div class="relative">
                        <i class="fas fa-notes-medical absolute left-3 top-3.5 text-slate-300 text-xs"></i>
                        <input v-model="newMed.reason" type="text" placeholder="ç—‡çŠ¶æˆ–åŸå› " class="w-full bg-slate-50 pl-9 p-3 rounded-xl text-sm border border-transparent focus:bg-white focus:border-orange-200 outline-none transition-all">
                    </div>
                    <button @click="addMedRecord" :disabled="!newMed.name" class="w-full bg-gradient-to-r from-orange-400 to-orange-500 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-orange-100 active:scale-95 transition disabled:opacity-50 disabled:shadow-none">
                        æäº¤è®°å½•
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center px-1">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Recent Logs</h3>
                    <button @click="showMedHistory = true" class="text-xs text-orange-500 font-bold hover:bg-orange-50 px-2 py-1 rounded transition">æŸ¥çœ‹å…¨éƒ¨</button>
                </div>
                <div v-for="(log, index) in medHistory.slice(0,3)" :key="log.id" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center group hover:border-orange-200 transition-colors">
                    <div class="flex items-center">
                        <div class="w-1 bg-orange-400 h-8 rounded-full mr-3"></div>
                        <div>
                            <p class="font-bold text-sm text-slate-700">{{ log.name }}</p>
                            <span class="text-[10px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded mt-1 inline-block">{{ log.reason }}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs font-bold text-slate-400">{{ formatDate(log.timestamp) }}</p>
                        <p class="text-[10px] text-slate-300">{{ formatTime(log.timestamp) }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Plans (Updated with Timeline & Search) -->
        <div v-if="currentTab === 'plans'" class="space-y-6">
            
            <!-- å¾…åŠå¡ç‰‡ (Pending) -->
            <div class="space-y-3">
                <div class="flex justify-between items-center px-1">
                    <h2 class="font-bold text-slate-700 text-sm">ğŸ“… è¿‘æœŸè®¡åˆ’</h2>
                    <button @click="openPlanEdit(null)" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-100 transition"><i class="fas fa-plus mr-1"></i>æ–°å¢</button>
                </div>
                
                <div v-if="pendingPlans.length === 0" class="bg-white p-6 rounded-2xl border border-dashed border-slate-200 text-center text-slate-400 text-xs">
                    æ²¡æœ‰å¾…åŠçš„æ£€æŸ¥è®¡åˆ’ï¼Œèº«ä½“æ£’æ£’å“’ï¼
                </div>

                <div v-for="plan in pendingPlans" :key="plan.id" @click="openPlanEdit(plan)" 
                     class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group hover:shadow-md transition-all cursor-pointer">
                    <div class="absolute top-0 left-0 w-1 h-full" :class="getPlanColor(plan.type).bar"></div>
                    <div class="flex justify-between items-center pl-3">
                        <div>
                            <div class="flex items-center mb-1">
                                <span class="text-xs font-bold px-2 py-0.5 rounded mr-2" :class="getPlanColor(plan.type).tag">{{ getPlanTypeName(plan.type) }}</span>
                                <h3 class="font-bold text-slate-700 text-sm">{{ plan.name }}</h3>
                            </div>
                            <p class="text-xs text-slate-400 flex items-center"><i class="far fa-clock mr-1.5 text-[10px]"></i> è®¡åˆ’æ—¥æœŸ: {{ plan.dueDate }}</p>
                        </div>
                        <i class="fas fa-chevron-right text-slate-200 text-xs group-hover:text-blue-400 transition-colors"></i>
                    </div>
                </div>
            </div>

            <!-- å†å²æ¡£æ¡ˆæœç´¢ & æ—¶é—´è½´ (History Timeline) -->
            <div class="pt-2">
                <!-- æœç´¢æ¡† -->
                <div class="sticky top-0 bg-gray-50 z-10 pb-4 pt-2">
                     <div class="flex justify-between items-center mb-2 px-1">
                        <h2 class="font-bold text-slate-500 text-sm">ğŸ“‚ å†å²æ¡£æ¡ˆ</h2>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input v-model="planSearch" type="text" placeholder="æœç´¢æ£€æŸ¥ç»“æœ..." class="w-full bg-white border border-slate-200 pl-9 pr-3 py-2.5 rounded-xl text-sm focus:border-blue-300 focus:ring-2 focus:ring-blue-100 outline-none transition-all shadow-sm">
                    </div>
                </div>

                <!-- æ—¶é—´è½´å®¹å™¨ -->
                <div class="relative pl-2 pb-10">
                    <div v-if="filteredDonePlans.length === 0" class="text-center text-slate-400 text-xs py-8">
                        {{ planSearch ? 'æœªæ‰¾åˆ°ç›¸å…³è®°å½•' : 'æš‚æ— å†å²è®°å½•' }}
                    </div>

                    <!-- Timeline Item -->
                    <div v-for="plan in filteredDonePlans" :key="plan.id" class="timeline-item relative pl-8 pb-8 timeline-line" @click="openPlanEdit(plan)">
                        <!-- Dot -->
                        <div class="absolute left-[9px] top-1.5 w-3.5 h-3.5 rounded-full border-2 border-white shadow-sm z-10" :class="getPlanColor(plan.type).dot"></div>
                        
                        <!-- Content Card -->
                        <div class="bg-white p-3.5 rounded-xl shadow-sm border border-slate-100 hover:border-blue-200 transition-colors cursor-pointer relative">
                            <!-- æ—¥æœŸæ ‡ç­¾ -->
                            <div class="absolute -top-3 right-3 bg-slate-100 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded shadow-sm border border-white">
                                {{ plan.doneDate }}
                            </div>

                            <h4 class="font-bold text-slate-700 text-sm mb-1 line-through decoration-slate-300 decoration-2 opacity-80">{{ plan.name }}</h4>
                            
                            <!-- ç»“æœæ‘˜è¦ (æ”¯æŒé«˜äº®æœç´¢è¯) -->
                            <div class="text-xs text-slate-500 bg-slate-50 p-2 rounded-lg mt-2 border border-slate-100">
                                <i class="fas fa-clipboard-check text-blue-400 mr-1"></i>
                                <span v-if="plan.resultSummary">{{ plan.resultSummary }}</span>
                                <span v-else class="italic text-slate-400">æ— è¯¦ç»†å¤‡æ³¨</span>
                            </div>
                            
                            <!-- é™„ä»¶æŒ‡ç¤ºå™¨ -->
                            <div v-if="plan.fileName" class="mt-2 flex items-center text-[10px] text-blue-500 font-medium">
                                <i class="fas fa-paperclip mr-1"></i> {{ plan.fileName }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Nav -->
    <nav class="bg-white border-t border-slate-100 shrink-0 pb-safe z-20 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
        <div class="flex justify-around items-center h-16">
            <button v-for="tab in tabs" :key="tab.id" @click="currentTab = tab.id" 
                class="flex flex-col items-center w-1/3 h-full justify-center transition-all duration-300 relative" 
                :class="currentTab === tab.id ? tab.color : 'text-slate-300 hover:text-slate-400'">
                <!-- Active Indicator -->
                <div v-if="currentTab === tab.id" class="absolute -top-[1px] w-8 h-1 rounded-b-full" :class="tab.bg"></div>
                
                <i :class="[tab.icon, 'text-xl mb-1 transition-transform duration-300', currentTab === tab.id ? '-translate-y-1' : '']"></i>
                <span class="text-[10px] font-bold tracking-wide">{{ tab.label }}</span>
            </button>
        </div>
    </nav>

    <!-- ================= MODALS ================= -->

    <!-- 1. Supp Config Modal -->
    <transition name="modal">
        <div v-if="showSuppManage" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-white w-full h-[85%] sm:h-auto sm:max-w-md sm:rounded-2xl rounded-t-2xl flex flex-col shadow-2xl">
                <div class="p-5 border-b flex justify-between items-center shrink-0">
                    <h3 class="font-bold text-slate-800">è¡¥å‰‚è®¾ç½®</h3>
                    <button @click="saveSuppConfig" class="text-slate-400"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-5 space-y-4 bg-slate-50">
                    <div v-for="(item, idx) in supplementsConfig" :key="item.id" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 flex items-center animate-fadeIn">
                        <div class="flex-1 space-y-2">
                            <input v-model="item.name" class="font-bold text-slate-700 w-full text-sm outline-none border-b border-transparent focus:border-emerald-200 placeholder-slate-300 bg-transparent" placeholder="åç§° (å¦‚: ç»´ç”Ÿç´ C)">
                            <div class="flex space-x-2">
                                <input v-model="item.dosage" class="text-xs bg-slate-100 rounded px-2 py-1 w-20 outline-none text-slate-600" placeholder="å‰‚é‡">
                                <select v-model="item.time" class="text-xs bg-slate-100 rounded px-2 py-1 outline-none text-slate-600">
                                    <option>æ—©æ™¨</option><option>åˆé¤</option><option>æ™šé¤</option><option>ç¡å‰</option>
                                </select>
                            </div>
                        </div>
                        <button @click="deleteSupplement(idx)" class="w-8 h-8 rounded-full text-slate-300 hover:bg-red-50 hover:text-red-400 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                    </div>
                    <button @click="addSupplementConfig" class="w-full py-3 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 font-bold text-sm hover:border-emerald-400 hover:text-emerald-500 transition">
                        <i class="fas fa-plus mr-1"></i> æ·»åŠ æ–°æ¡ç›®
                    </button>
                </div>
                <div class="p-5 border-t bg-white pb-safe rounded-b-2xl">
                    <button @click="saveSuppConfig" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-slate-200">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 2. Supp History Calendar Modal -->
    <transition name="modal">
        <div v-if="showSuppHistory" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center px-6">
            <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6 relative">
                <button @click="showSuppHistory = false" class="absolute top-4 right-4 text-slate-300 hover:text-slate-500"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-slate-800 mb-6 text-center">æœ¬æœˆæ‰“å¡è®°å½•</h3>
                <div class="grid grid-cols-7 gap-2 mb-2 text-center">
                    <span v-for="d in ['S','M','T','W','T','F','S']" :key="d" class="text-[10px] font-bold text-slate-300">{{d}}</span>
                </div>
                <div class="grid grid-cols-7 gap-2">
                    <div v-for="n in 30" :key="n" class="aspect-square rounded-lg flex items-center justify-center text-xs font-medium transition-all"
                         :class="getDayClass(n)">
                        {{ n }}
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <!-- 3. Meds History (Searchable) -->
    <transition name="modal">
        <div v-if="showMedHistory" class="absolute inset-0 z-50 bg-white flex flex-col">
            <div class="p-4 border-b flex items-center space-x-3 pt-safe bg-white z-10">
                <button @click="showMedHistory = false" class="text-slate-500 w-8"><i class="fas fa-arrow-left"></i></button>
                <div class="flex-1 bg-slate-100 rounded-xl flex items-center px-3 py-2.5">
                    <i class="fas fa-search text-slate-400 mr-2 text-xs"></i>
                    <input v-model="medSearch" type="text" placeholder="æœç´¢è¯å“æˆ–ç—‡çŠ¶..." class="bg-transparent w-full text-sm outline-none text-slate-700 placeholder-slate-400">
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50">
                <div v-for="log in filteredMedHistory" :key="log.id" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <h4 class="font-bold text-slate-700">{{ log.name }}</h4>
                        <span class="text-xs text-slate-400">{{ formatDate(log.timestamp) }}</span>
                    </div>
                    <p class="text-sm text-slate-500 mt-1 bg-slate-50 p-2 rounded-lg inline-block">ç—‡çŠ¶: {{ log.reason }}</p>
                </div>
                <div v-if="filteredMedHistory.length === 0" class="text-center text-slate-400 mt-20 text-sm">
                    <i class="fas fa-search mb-2 text-2xl opacity-20 block"></i>
                    æœªæ‰¾åˆ°ç›¸å…³è®°å½•
                </div>
            </div>
        </div>
    </transition>

    <!-- 4. Plan Edit Modal -->
    <transition name="modal">
        <div v-if="editingPlan" class="absolute inset-0 z-50 bg-slate-900/40 backdrop-blur-sm flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl max-h-[90%] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-bold text-slate-800">{{ editingPlan.id ? 'è¯¦æƒ… / ç¼–è¾‘' : 'æ–°å»ºæ£€æŸ¥è®¡åˆ’' }}</h3>
                    <button @click="closePlanEdit" class="text-slate-300 hover:text-slate-500"><i class="fas fa-times text-xl"></i></button>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase mb-1.5 block">é¡¹ç›®åç§°</label>
                        <input v-model="editingPlanTemp.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:border-blue-400 outline-none font-bold text-slate-700" placeholder="ä¾‹å¦‚: è¡€å¸¸è§„">
                    </div>
                    
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1.5 block">ç±»å‹</label>
                            <select v-model="editingPlanTemp.type" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none text-slate-600 appearance-none">
                                <option value="annual">å¹´åº¦å¤§æ£€</option>
                                <option value="quarterly">å­£åº¦æ£€æŸ¥</option>
                                <option value="dental">ç‰™ç§‘/ä¸“é¡¹</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-400 uppercase mb-1.5 block">æ—¥æœŸ</label>
                            <input v-model="editingPlanTemp.dueDate" type="date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none text-slate-600">
                        </div>
                    </div>

                    <!-- Result Section -->
                    <div v-if="editingPlan.id" class="pt-4 border-t border-slate-100">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-xs font-bold text-blue-500 uppercase tracking-wide"><i class="fas fa-file-medical-alt mr-1"></i>ç»“æœå½’æ¡£</label>
                            <span v-if="editingPlanTemp.status === 'done'" class="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded font-bold">å·²å½’æ¡£</span>
                        </div>
                        
                        <div class="bg-blue-50/50 p-4 rounded-xl border border-blue-100/50 space-y-3">
                            <textarea v-model="editingPlanTemp.resultSummary" rows="3" class="w-full bg-white border border-blue-100 rounded-xl p-3 text-sm placeholder-blue-300 focus:ring-2 focus:ring-blue-100 outline-none resize-none" placeholder="è¾“å…¥åŒ»ç”Ÿå»ºè®®æˆ–ä¸»è¦æŒ‡æ ‡..."></textarea>
                            
                            <div class="relative border-2 border-dashed border-blue-200 rounded-xl p-4 text-center bg-white hover:bg-blue-50 transition cursor-pointer group">
                                <input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" @change="handleFileUpload">
                                <div v-if="!editingPlanTemp.fileName" class="group-hover:scale-105 transition-transform">
                                    <i class="fas fa-cloud-upload-alt text-blue-300 text-2xl mb-1"></i>
                                    <p class="text-[10px] text-blue-400 font-medium">ç‚¹å‡»ä¸Šä¼ æŠ¥å‘Šå•</p>
                                </div>
                                <div v-else class="flex items-center justify-center text-blue-600">
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    <span class="text-xs font-bold truncate max-w-[150px]">{{ editingPlanTemp.fileName }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex space-x-3">
                    <button v-if="editingPlan.id" @click="deletePlan" class="px-5 py-3.5 rounded-xl text-red-400 bg-red-50 font-bold text-sm hover:bg-red-100 hover:text-red-500 transition"><i class="fas fa-trash-alt"></i></button>
                    
                    <div class="flex-1 flex space-x-3">
                        <template v-if="editingPlanTemp.status === 'done'">
                             <button @click="savePlan(false)" class="flex-1 bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-slate-200">æ›´æ–°è®°å½•</button>
                        </template>
                        <template v-else>
                            <button @click="savePlan(false)" class="flex-1 bg-white border border-slate-200 text-slate-600 py-3.5 rounded-xl font-bold">ä¿å­˜</button>
                            <button @click="savePlan(true)" class="flex-1 bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition">
                                <i class="fas fa-check mr-1"></i> å®Œæˆå½’æ¡£
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                currentTab: 'plans', // é»˜è®¤å±•ç¤ºæ›´æ–°åçš„ Plans Tab
                currentDate: new Date().toLocaleDateString('en-US', {month:'long', day:'numeric', weekday:'short'}), // è‹±æ–‡æ—¥æœŸæ›´ç¾è§‚
                tabs: [
                    { id: 'daily', label: 'Daily', icon: 'fas fa-sun', color: 'text-emerald-500', bg:'bg-emerald-500' },
                    { id: 'meds', label: 'Meds', icon: 'fas fa-capsules', color: 'text-orange-500', bg:'bg-orange-500' },
                    { id: 'plans', label: 'Plans', icon: 'fas fa-clipboard-list', color: 'text-blue-500', bg:'bg-blue-500' }
                ],
                
                // Supps
                showSuppManage: false,
                showSuppHistory: false,
                supplementsConfig: [], 
                dailyRecords: {}, 

                // Meds
                newMed: { name: '', reason: '' },
                medHistory: [],
                showMedHistory: false,
                medSearch: '',

                // Plans (Updated)
                healthPlans: [],
                editingPlan: null, 
                editingPlanTemp: {}, 
                planSearch: '', // æ–°å¢ï¼šæœç´¢å…³é”®è¯
            }
        },
        computed: {
            activeSupplements() {
                return this.supplementsConfig.map(item => ({ ...item, done: !!this.dailyRecords[item.id] }));
            },
            completionRate() {
                if (this.supplementsConfig.length === 0) return 0;
                return Math.round((Object.values(this.dailyRecords).filter(Boolean).length / this.supplementsConfig.length) * 100);
            },
            filteredMedHistory() {
                if (!this.medSearch) return this.medHistory;
                const q = this.medSearch.toLowerCase();
                return this.medHistory.filter(l => l.name.toLowerCase().includes(q) || l.reason.toLowerCase().includes(q));
            },
            // Plans Logic
            pendingPlans() { return this.healthPlans.filter(p => p.status !== 'done').sort((a,b) => a.dueDate.localeCompare(b.dueDate)); },
            filteredDonePlans() { 
                let list = this.healthPlans.filter(p => p.status === 'done');
                // æœç´¢é€»è¾‘
                if (this.planSearch) {
                    const q = this.planSearch.toLowerCase();
                    list = list.filter(p => 
                        p.name.toLowerCase().includes(q) || 
                        (p.resultSummary && p.resultSummary.toLowerCase().includes(q))
                    );
                }
                return list.sort((a,b) => b.doneDate.localeCompare(a.doneDate)); // å€’åº
            }
        },
        mounted() {
            this.initData();
        },
        methods: {
            initData() {
                // æ¨¡æ‹Ÿæ•°æ®
                this.supplementsConfig = JSON.parse(localStorage.getItem('v2.1_suppConfig')) || [{ id: 1, name: 'Vitamin C', dosage: '500mg', time: 'æ—©æ™¨' }];
                const today = new Date().toDateString();
                if (localStorage.getItem('v2.1_lastDate') !== today) {
                    this.dailyRecords = {};
                    localStorage.setItem('v2.1_lastDate', today);
                } else {
                    this.dailyRecords = JSON.parse(localStorage.getItem('v2.1_dailyRecords')) || {};
                }
                this.medHistory = JSON.parse(localStorage.getItem('v2.1_meds')) || [];
                // é¢„ç½®ä¸€äº›å†å²æ•°æ®ä»¥å±•ç¤ºæ—¶é—´è½´æ•ˆæœ
                this.healthPlans = JSON.parse(localStorage.getItem('v2.1_plans')) || [
                    { id: 101, name: 'å®šæœŸæ´—ç‰™', type: 'dental', dueDate: '2025-06-01', status: 'pending' },
                    { id: 100, name: 'å…¨èº«æŸ¥ä½“', type: 'annual', dueDate: '2024-10-15', doneDate:'2024-10-15', status: 'done', resultSummary: 'ç”˜æ²¹ä¸‰é…¯åé«˜ï¼Œå»ºè®®å°‘æ²¹å°‘ç›', fileName: 'Report.pdf' },
                    { id: 99, name: 'ç‰™é½¿æ£€æŸ¥', type: 'dental', dueDate: '2024-06-01', doneDate:'2024-06-02', status: 'done', resultSummary: 'æ— é¾‹é½¿' }
                ];
            },
            saveAll() {
                localStorage.setItem('v2.1_suppConfig', JSON.stringify(this.supplementsConfig));
                localStorage.setItem('v2.1_dailyRecords', JSON.stringify(this.dailyRecords));
                localStorage.setItem('v2.1_meds', JSON.stringify(this.medHistory));
                localStorage.setItem('v2.1_plans', JSON.stringify(this.healthPlans));
            },
            
            // --- Logic Methods ---
            toggleSupplement(id) { this.dailyRecords[id] = !this.dailyRecords[id]; this.saveAll(); },
            resetDaily() { this.dailyRecords = {}; this.saveAll(); },
            addSupplementConfig() { this.supplementsConfig.push({ id: Date.now(), name: '', dosage: '', time: 'æ—©æ™¨' }); },
            saveSuppConfig() { this.supplementsConfig = this.supplementsConfig.filter(s => s.name.trim()); this.showSuppManage = false; this.saveAll(); },
            deleteSupplement(idx) { this.supplementsConfig.splice(idx, 1); },
            addMedRecord() {
                this.medHistory.unshift({ id: Date.now(), name: this.newMed.name, reason: this.newMed.reason, timestamp: Date.now() });
                this.newMed = { name: '', reason: '' }; this.saveAll();
            },
            
            // --- Plans Enhanced Logic ---
            getPlanColor(type) {
                const map = {
                    'annual': { bar: 'bg-blue-500', tag: 'bg-blue-100 text-blue-600', dot: 'bg-blue-500 border-blue-500' },
                    'quarterly': { bar: 'bg-indigo-400', tag: 'bg-indigo-100 text-indigo-600', dot: 'bg-indigo-400 border-indigo-400' },
                    'dental': { bar: 'bg-teal-400', tag: 'bg-teal-100 text-teal-600', dot: 'bg-teal-400 border-teal-400' }
                };
                return map[type] || { bar: 'bg-slate-400', tag: 'bg-slate-100', dot: 'bg-slate-300' };
            },
            getPlanTypeName(type) {
                return { 'annual':'å¹´åº¦', 'quarterly':'å­£åº¦', 'dental':'ç‰™ç§‘' }[type] || 'å…¶ä»–';
            },
            openPlanEdit(plan) {
                this.editingPlan = plan || {};
                this.editingPlanTemp = plan ? JSON.parse(JSON.stringify(plan)) : { id: null, name: '', type: 'quarterly', dueDate: '', status: 'pending', resultSummary: '' };
            },
            closePlanEdit() { this.editingPlan = null; },
            handleFileUpload(e) { if(e.target.files[0]) this.editingPlanTemp.fileName = e.target.files[0].name; },
            
            savePlan(markAsDone) {
                if(!this.editingPlanTemp.name) return;
                
                // è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡æ—¥æœŸçš„é€»è¾‘ (Connection Logic)
                let nextDateProposal = null;
                
                if (markAsDone) {
                    this.editingPlanTemp.status = 'done';
                    this.editingPlanTemp.doneDate = new Date().toISOString().split('T')[0];
                    
                    // ç®€å•çš„é€»è¾‘è®¡ç®—ä¸‹æ¬¡æ—¶é—´
                    const current = new Date(this.editingPlanTemp.dueDate || Date.now());
                    if (this.editingPlanTemp.type === 'annual') current.setFullYear(current.getFullYear() + 1);
                    else if (this.editingPlanTemp.type === 'quarterly') current.setMonth(current.getMonth() + 3);
                    else if (this.editingPlanTemp.type === 'dental') current.setMonth(current.getMonth() + 6);
                    
                    nextDateProposal = current.toISOString().split('T')[0];
                }

                if (this.editingPlanTemp.id) {
                    const idx = this.healthPlans.findIndex(p => p.id === this.editingPlanTemp.id);
                    if (idx !== -1) this.healthPlans[idx] = this.editingPlanTemp;
                } else {
                    this.editingPlanTemp.id = Date.now();
                    this.healthPlans.push(this.editingPlanTemp);
                }

                // åˆ›å»ºä¸‹ä¸€æ¬¡å¾ªç¯ (Auto-Create Recurrence)
                if (markAsDone && nextDateProposal) {
                    if(confirm(`å·²å®Œæˆå½’æ¡£ï¼\næ ¹æ®ç±»å‹ [${this.getPlanTypeName(this.editingPlanTemp.type)}], æ˜¯å¦è‡ªåŠ¨åˆ›å»ºä¸‹ä¸€æ¬¡è®¡åˆ’ï¼Ÿ\n\né¢„è®¡æ—¥æœŸ: ${nextDateProposal}`)) {
                        this.healthPlans.push({
                            id: Date.now() + 1,
                            name: this.editingPlanTemp.name,
                            type: this.editingPlanTemp.type,
                            dueDate: nextDateProposal,
                            status: 'pending'
                        });
                    }
                }

                this.saveAll();
                this.closePlanEdit();
            },
            deletePlan() {
                if(!confirm('Delete?')) return;
                this.healthPlans = this.healthPlans.filter(p => p.id !== this.editingPlanTemp.id);
                this.saveAll();
                this.closePlanEdit();
            },

            // Formatters
            formatDate(ts) { return new Date(ts).toLocaleDateString('zh-CN', {month:'short', day:'numeric'}); },
            formatTime(ts) { return new Date(ts).toLocaleTimeString('zh-CN', {hour:'2-digit', minute:'2-digit'}); },
            getDayClass(n) {
                if (n > 25) return 'bg-slate-50 text-slate-200'; // future
                return Math.random() > 0.3 ? 'bg-emerald-500 text-white shadow-md shadow-emerald-200' : 'bg-emerald-50 text-emerald-400';
            }
        }
    }).mount('#app');
</script>
</body>
</html>